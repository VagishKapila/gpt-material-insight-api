<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Log Upload</title>
</head>
<body>
  <h2>Submit Daily Log</h2>
  <form id="logForm" method="POST" enctype="multipart/form-data">
    <!-- Form fields (same as before) -->
    <label>Project Name: <input type="text" name="project_name" required></label><br>
    <label>Date: <input type="date" name="date" required></label><br>
    <label>Client Name: <input type="text" name="client_name"></label><br>
    <label>Job Number: <input type="text" name="job_number"></label><br>
    <label>Prepared By: <input type="text" name="prepared_by"></label><br>
    <label>Location: <input type="text" name="location"></label><br>
    <label>GC or Sub: <input type="text" name="gc_or_sub"></label><br>
    <label>Crew Notes: <textarea name="crew_notes"></textarea></label><br>
    <label>Work Done: <textarea name="work_done"></textarea></label><br>
    <label>Deliveries: <textarea name="deliveries"></textarea></label><br>
    <label>Inspections: <textarea name="inspections"></textarea></label><br>
    <label>Equipment Used: <textarea name="equipment_used"></textarea></label><br>
    <label>Safety Notes: <textarea name="safety_notes"></textarea></label><br>
    <label>Weather: <input type="text" name="weather"></label><br>
    <label>Additional Notes: <textarea name="notes"></textarea></label><br>

    <!-- File input -->
    <label>Upload Job Site Photos (up to 20):</label>
    <input type="file" name="photos" id="photoInput" multiple accept="image/*"><br><br>

    <button type="submit">Submit Log</button>
  </form>

  <script>
    const form = document.getElementById('logForm');
    const photoInput = document.getElementById('photoInput');

    form.addEventListener('submit', async function (event) {
      event.preventDefault();

      const compressedPhotos = await compressPhotos(photoInput.files);

      const formData = new FormData(form);
      // Remove original photos
      formData.delete('photos');

      // Append compressed ones
      compressedPhotos.forEach((blob, index) => {
        formData.append('photos', blob, `compressed_photo_${index}.jpg`);
      });

      const response = await fetch('/form', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        alert('Log submitted successfully!');
      } else {
        alert('Upload failed.');
      }
    });

    async function compressPhotos(files) {
      const compressed = [];

      for (let file of files) {
        const img = await createImageBitmap(file);
        const canvas = document.createElement('canvas');
        const maxWidth = 1024;
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const blob = await new Promise(resolve =>
          canvas.toBlob(resolve, 'image/jpeg', 0.4) // 40% quality
        );
        compressed.push(blob);
      }
      return compressed;
    }
  </script>
</body>
</html>
