<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nails & Notes ‚Äì Daily Log</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
    form { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #aaa; }
    #loader { display: none; text-align: center; margin-top: 15px; color: #555; }
    #result { margin-top: 20px; text-align: center; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Submit Daily Log</h2>

  <form id="logForm" method="POST" action="/submit" enctype="multipart/form-data">
    <label>Project Name: <input type="text" name="project_name" required></label>
    <label>Date: <input type="date" name="date" required></label>
    <label>Client Name: <input type="text" name="client_name"></label>
    <label>Job Number: <input type="text" name="job_number"></label>
    <label>Prepared By: <input type="text" name="prepared_by"></label>
    <label>Location: <input type="text" name="location"></label>
    <label>GC or Sub: <input type="text" name="gc_or_sub"></label>
    <label>Crew Notes: <textarea name="crew_notes"></textarea></label>
    <label>Work Done: <textarea name="work_done"></textarea></label>
    <label>Deliveries: <textarea name="deliveries"></textarea></label>
    <label>Inspections: <textarea name="inspections"></textarea></label>
    <label>Equipment Used: <textarea name="equipment_used"></textarea></label>
    <label>Safety Notes: <textarea name="safety_notes"></textarea></label>
    <label>Weather: <input type="text" name="weather"></label>
    <label>Additional Notes: <textarea name="notes"></textarea></label>
    <label>Upload Job Site Photos (up to 20):</label>
    <input type="file" name="photos" id="photoInput" multiple accept="image/*"><br><br>

    <button type="submit">Submit Log</button>
    <div id="loader">‚è≥ Generating PDF... Please wait...</div>
    <div id="result"></div>
  </form>

  <script>
    const form = document.getElementById('logForm');
    const photoInput = document.getElementById('photoInput');
    const loader = document.getElementById('loader');
    const result = document.getElementById('result');

    form.addEventListener('submit', async function (event) {
      event.preventDefault();
      loader.style.display = 'block';
      result.innerHTML = '';

      const compressedPhotos = await compressPhotos(photoInput.files);
      const formData = new FormData(form);
      formData.delete('photos');
      compressedPhotos.forEach((blob, index) => {
        formData.append('photos', blob, `compressed_${index}.jpg`);
      });

      try {
        const response = await fetch('/submit', {
          method: 'POST',
          body: formData
        });

        loader.style.display = 'none';

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          result.innerHTML = `<a href="${url}" download="DailyLog.pdf">üìÑ Download Your PDF</a>`;
        } else {
          result.innerHTML = '<span style="color:red;">Upload failed. Try again.</span>';
        }
      } catch (error) {
        loader.style.display = 'none';
        result.innerHTML = '<span style="color:red;">Network error. Please retry.</span>';
      }
    });

    async function compressPhotos(files) {
      const compressed = [];
      for (let file of files) {
        const img = await createImageBitmap(file);
        const canvas = document.createElement('canvas');
        const maxWidth = 1024;
        const scale = Math.min(1, maxWidth / img.width);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.5));
        compressed.push(blob);
      }
      return compressed;
    }
  </script>
</body>
</html>
